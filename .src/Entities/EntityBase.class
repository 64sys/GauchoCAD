' Gambas class file

' GauchoCAD
' A simple CAD made in Gambas
'
' Copyright (C) Ing Martin P Cristia
'
' This program is free software; you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation; either version 3 of the License, or
' (at your option) any later version.
'
' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License
' along with this program; if not, write to the Free Software
' Foundation, Inc., 51 Franklin St, Fifth Floor,
' Boston, MA  02110-1301  USA

Create Static
Fast

Public Const GAMBASCADENTITY As String = ("EntityBase")
Public Const GENDER As String = "Arc"
Public Const USEWITH As String = "clsEntityBuilder"
Public Const DrawingOrder As Integer = 0        ' 1 = draws first
Public Const PointsToDraw As Integer = 1             ' minimal point requered for drawing something usefull
Public Const OrtogonalIgnorado As Boolean = False
Public Const OrtogonalForzado As Boolean = False
Public Const ParamDefault As String = " "
Public Const StretchAble As Boolean = True           ' Si lo puedo deformar
Public Selected As Boolean
Public ForDeletion As Boolean = True        ' this must be falsed in Finish
Public DrawAble As Boolean = False          ' True si durante la construccion ya tiene suficientes elementos para poder hacer una representacion digna
Public Visible As Boolean = True            ' si esta entidad puede ser mostrada independientmente
Public Finished As Boolean = False          ' colocar en true cuando se llegue a completar
Public StepsDone As Integer                 ' esto lo cambia cls ElementBuilder durante la construccion
' point of interest

Public Sub _new()

End

Public Function _compare(cosas As Object) As Integer

    Return Sgn(Me.DrawingOrder - cosas.DrawingOrder)

End

'' Las entidades pueden proveer un poligono que las envuelva
'' el mismo su usara para seleccionarlas.
Public Sub CreateBoundingPoligon(oE As Entity)

End

' Public Sub Draw(oE As Entity)
'
'     If  Not oE.Visible Then Return
'
'     ' AQUI VAN LAS RUTINAS DE DIBUJO
'
' End

'' Determines if the entity was selected by a rectanle surrounding al points
'' by default, if ALL points are selected, it can.
Public Function SelFull(oE As Entity, X1real As Float, Y1real As Float, X2real As Float, Y2real As Float) As Boolean

    Dim i As Integer, puedo As Boolean

    ' Si tengo un bounding poligon, entonces verifico que todos los puntos esten dentro
    If oE.BoundingPoligon.Count > 0 Then

        Return puntos.IsPoligonInsideRect(oE.BoundingPoligon, X1real, Y1real, X2real, Y2real)

    Else    ' no tengo un poligono, entonces verifico que todos los puntos definitorios de al entidad esten dentro

        puedo = True                     ' supongamos que puedo, por ahora
        For i = 0 To oE.p.max Step 2
            If Not (oE.p[i] >= X1real And oE.p[i] <= X2real) And (oE.p[i + 1] >= Y1real And oE.p[i + 1] <= Y2real) Then
                puedo = False
            End If
        Next

        If puedo Then
            For i = 0 To oE.PSel.Max
                oE.PSel[i] = True
            Next

            Return True
        Else
            For i = 0 To oE.PSel.Max
                oE.PSel[i] = False
            Next

            Return False
        End If
    Endif

End

'' Determines if the entity can be stretched
'' by default, if ANY point is selected, it can.
Public Function SelPartial(oE As Entity, X1real As Float, Y1real As Float, X2real As Float, Y2real As Float) As Boolean

    Dim i As Integer, puedo As Boolean

    ' Si tengo un bounding poligon, entonces verifico que alguna linea lo cruce
    If oE.BoundingPoligon.Count > 0 Then

        Return puntos.IsPoligonCrossingRect(oE.BoundingPoligon, X1real, Y1real, X2real, Y2real)

    Else    ' no tengo un poligono, entonces verifico que todos los puntos definitorios de al entidad esten dentro

        puedo = False
        For i = 0 To oE.p.max Step 2
            If (oE.p[i] >= X1real And oE.p[i] <= X2real) And (oE.p[i + 1] >= Y1real And oE.p[i + 1] <= Y2real) Then
                oE.PSel[i / 2] = True
                puedo = True
            End If
        Next

        If puedo Then

            Return True
        Else
            Return False
        End If
    End If

End

''      0 No busca nada en particular = Nearest
''      1       Endpoint
''      2       Midpoint
''      4       Perpendicular
''      8       Center
''      16      Quadrant
''      32      Perpendicular
''      64      Perpendicular
''      128     Perpendicular
''      256     Perpendicular
Public Function AboveMe(oE As Entity, Xreal As Float, Yreal As Float, tolerance As Float, mode As Integer, returnData As Float[]) As Boolean

    ' this could be overriden in the child

    returnData.Insert([0, 0, -1])               ' minimal response
    If oE.P.Count = 0 Then Return

    If puntos.Around(Xreal, yreal, oE.P[0], oE.P[1], APPMain.hFCAD.Metros(10)) Then

        returnData[0] = oE.P[0]
        returnData[1] = oE.P[1]
        returnData[2] = 0
        Return True

    Else If oE.BoundingPoligon.Count > 0 Then

        If puntos.isInside(oE.BoundingPoligon, oE.BoundingPoligon.Count / 2, Xreal, yreal) Then
            returnData[0] = Xreal
            returnData[1] = yreal
            returnData[2] = 0

            Return True

        End If

    Else

        Return False
    End If

End

Public Sub PointClick(oE As Entity, Xr As Float, Yr As Float) As Boolean

    ' this could be overriden in the child

    If oE.BoundingPoligon.Count = 0 Then Return False

    If puntos.isInside(oE.BoundingPoligon, oE.BoundingPoligon.Count / 2, xr, Yr) Then

        Return True
    Else

        Return False
    End If

End

'' Creo los puntos de interes
'' Build point of interest

Public Function BuildPOI(oE As Entity, Optional arrIndex As Integer = -1) As Integer

End

' This function will return False if the element couldn't be created for some reason: bad or incomple user input
' True means all is good, False will instruct the clsEntityBuilder to delete it
Public Sub Finish(oE As Entity, ParamsDone As Integer) As Boolean

    'Print "Finish en EntityBase"
    'CreateBoundingPoligon(oe)
    BuildPOI(oe)

    ' busco el tipo de linea, si hace falta
    If oE.LineTypeName = "Dashed" Then oE.LineType = 1
    ' tareas finales de armado del objeto
    oE.b.resize(oE.P.count)
    oE.psel.resize(oE.p.count / 2)
    oE.ForDeletion = False
    oE.DrawAble = True
    oE.Selected = False
    oE.Finished = True

    If Not True Then

        oE.ForDeletion = True
        oE.DrawAble = False

    End If

End
